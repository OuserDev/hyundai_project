---
# 플레이북 이름: 화면보호기 대기 시간 설정 및 재시작 시 암호 보호 설정
# 설명: OS 화면 잠금(Screen Lock) 설정의 대기 시간과 암호 보호 활성화 여부를 진단하고 권고합니다.
# 주의: 이 항목은 GUI 환경에 종속되며, 자동 조치는 사용자 불편 및 시스템 접근 문제의 위험이 있어 권장되지 않습니다.
- name: 화면보호기 대기 시간 설정 및 재시작 시 암호 보호 설정 점검 (권고)
  hosts: localhost # 로컬 시스템(현재 실행 중인 호스트)을 대상으로 합니다.
  become: no       # 이 설정은 사용자별 GUI 설정이므로, root 권한이 필수는 아닐 수 있습니다.
                   # 하지만 gsettings 접근을 위해 필요할 수 있어, 필요시 become: yes 사용.
                   # 일반적으로 사용자의 세션에서 실행되어야 함.

  vars:
    # 권고되는 최대 화면 잠금 대기 시간 (초) - 10분 = 600초
    max_idle_delay_seconds: 600
    # 권고되는 화면 보호기 잠금 활성화 여부
    required_lock_enabled: "true"

  tasks:
    # --- 1. 진단 섹션 시작 ---

    - name: 진단 결과 초기화
      ansible.builtin.set_fact:
        diagnosis_results:
          status: "진단 불가 (GUI 환경 또는 gsettings 부재)"
          reasons: []
          needs_fix: false
          current_idle_delay: "N/A"
          current_lock_enabled: "N/A"
          system_has_gui: false # GUI 환경 여부
          gsettings_available: false # gsettings 명령 사용 가능 여부

    - name: X server (GUI) 프로세스 존재 여부 확인
      ansible.builtin.shell: "pgrep -f 'Xorg|gnome-shell|kwin_x11|xfce4-session' || true"
      register: gui_process_check
      changed_when: false
      ignore_errors: true

    - name: 시스템에 GUI 환경이 있는지 여부 설정
      ansible.builtin.set_fact:
        diagnosis_results: >-
          {{ diagnosis_results | combine({
              'system_has_gui': (gui_process_check.stdout | length > 0)
            }, recursive=True)
          }}

    - name: gsettings 명령 존재 여부 확인
      ansible.builtin.command: "which gsettings"
      register: gsettings_path
      changed_when: false
      ignore_errors: true

    - name: gsettings 사용 가능 여부 설정
      ansible.builtin.set_fact:
        diagnosis_results: >-
          {{ diagnosis_results | combine({
              'gsettings_available': (gsettings_path.rc == 0)
            }, recursive=True)
          }}

    - name: gsettings에서 화면 잠금 대기 시간 확인
      ansible.builtin.command: "gsettings get org.gnome.desktop.session idle-delay"
      register: idle_delay_output
      changed_when: false
      ignore_errors: true
      when: diagnosis_results.system_has_gui and diagnosis_results.gsettings_available

    - name: gsettings에서 화면 보호기 잠금 활성화 여부 확인
      ansible.builtin.command: "gsettings get org.gnome.desktop.screensaver lock-enabled"
      register: lock_enabled_output
      changed_when: false
      ignore_errors: true
      when: diagnosis_results.system_has_gui and diagnosis_results.gsettings_available

    - name: 진단 결과 업데이트 (gsettings 값 기반)
      ansible.builtin.set_fact:
        current_idle_delay_value: "{{ (idle_delay_output.stdout | default('0') | replace('uint32 ', '') | int) / 60 }}" # 초를 분으로 변환
        current_lock_enabled_value: "{{ lock_enabled_output.stdout | default('false') | trim }}"
        diagnosis_results: >-
          {{ diagnosis_results | combine({
              'current_idle_delay': ((idle_delay_output.stdout | default('0') | replace('uint32 ', '') | int) / 60) if idle_delay_output.rc == 0 else 'N/A',
              'current_lock_enabled': (lock_enabled_output.stdout | default('false') | trim) if lock_enabled_output.rc == 0 else 'N/A'
            }, recursive=True)
          }}
      when: diagnosis_results.system_has_gui and diagnosis_results.gsettings_available

    - name: 최종 진단 결과 업데이트 (취약 여부 판단)
      ansible.builtin.set_fact:
        diagnosis_results: >-
          {{ diagnosis_results | combine({
              'status': '취약',
              'needs_fix': true,
              'reasons': diagnosis_results.reasons + ['화면 잠금 대기 시간이 10분을 초과합니다. (현재: {{ current_idle_delay_value }}분)'] if diagnosis_results.system_has_gui and diagnosis_results.gsettings_available and current_idle_delay_value > (max_idle_delay_seconds / 60) else []
            }) | combine({
              'reasons': diagnosis_results.reasons + ['화면 보호기 재시작 시 암호 보호가 활성화되어 있지 않습니다.'] if diagnosis_results.system_has_gui and diagnosis_results.gsettings_available and current_lock_enabled_value != required_lock_enabled else []
            })
          }}
      when:
        - diagnosis_results.system_has_gui and diagnosis_results.gsettings_available
        - (current_idle_delay_value > (max_idle_delay_seconds / 60)) or (current_lock_enabled_value != required_lock_enabled)

    - name: 최종 진단 결과 출력
      ansible.builtin.debug:
        msg: |
          <진단 결과: {{ diagnosis_results.status }}>
          {% if not diagnosis_results.system_has_gui %}
            시스템에 GUI 환경이 감지되지 않아 화면보호기 설정을 진단할 수 없습니다. (서버 환경으로 추정)
          {% elif not diagnosis_results.gsettings_available %}
            `gsettings` 명령을 찾을 수 없어 화면보호기 설정을 진단할 수 없습니다. (GNOME 환경이 아니거나 도구 부재)
          {% else %}
            현재 화면 잠금 대기 시간: {{ diagnosis_results.current_idle_delay }}분 (권고: {{ max_idle_delay_seconds / 60 }}분 이하)
            현재 암호 보호 설정: {{ diagnosis_results.current_lock_enabled }} (권고: {{ required_lock_enabled }})

            {% if diagnosis_results.needs_fix %}
              세부 사유:
              {% for reason in diagnosis_results.reasons %}
                - {{ reason }}
              {% endfor %}
              조치 권고:
              - **자동 조치 불가: 이 설정은 사용자별 GUI 설정이므로 수동으로 변경해야 합니다.**
              - 다음 경로에서 화면보호기 설정을 변경하십시오:
                `Settings` → `Privacy` → `Screen Lock`
              - `Screen Lock`을 활성화하십시오.
              - `Blank screen delay` (빈 화면 지연 시간) 및 `Automatic Screen Lock delay` (자동 화면 잠금 지연 시간) 설정을 확인하고, **두 시간의 합계가 10분 이하**가 되도록 조정하십시오.
                (예: Blank screen delay 5분, Automatic Screen Lock delay 5분)
              - `Automatic Lock` 토글이 활성화되어 있는지 확인하십시오.
            {% else %}
              화면보호기 설정(대기 시간 10분 이하) 및 암호 보호가 양호하게 설정되어 있습니다.
            {% endif %}
          {% endif %} {# <-- 여기 추가: 가장 바깥쪽 if 문을 닫는 endif #}
      when: diagnosis_results is defined
