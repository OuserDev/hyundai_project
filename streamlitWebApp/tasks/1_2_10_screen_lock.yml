---
- name: ì§„ë‹¨ ë° ì¡°ì¹˜ - í™”ë©´ë³´í˜¸ê¸° ëŒ€ê¸° ì‹œê°„ ë° ì•”í˜¸ ì„¤ì •
  hosts: target_servers
  ignore_errors: true
  ignore_unreachable: true
  any_errors_fatal: false
  become: yes
  gather_facts: yes

  # 1. ë³€ìˆ˜ ì •ì˜
  vars:
    # --- ì„¤ì • ëª©í‘œ ---
    lock_delay_seconds: 600 # 10ë¶„
    lock_enabled: true

    # --- dconf ì„¤ì • ê²½ë¡œ (GNOME) ---
    dconf_profile_path: "/etc/dconf/profile/gdm"
    dconf_db_path: "/etc/dconf/db/gdm.d"
    dconf_keyfile_path: "{{ dconf_db_path }}/00-security-settings"

    # --- ë³´ê³ ì„œ ê´€ë ¨ ---
    playbook_name: "1_2_10_screen_lock.yml"
    remediation_tasks_performed: []
    manual_remediation_guide: "gsettings ë˜ëŠ” dconf-editorë¥¼ ì‚¬ìš©í•˜ì—¬ org.gnome.desktop.session idle-delayë¥¼ 600 ì´í•˜ë¡œ, org.gnome.desktop.screensaver lock-enabledë¥¼ trueë¡œ ì„¤ì •í•˜ì‹­ì‹œì˜¤."

  handlers:
    - name: dconf ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸
      ansible.builtin.command: dconf update
      listen: "update dconf database"

  tasks:
    # ğŸ”§ ì‚¬ì „ ì²´í¬: Facts ìˆ˜ì§‘ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ ì„¤ì •
    - name: Facts ìˆ˜ì§‘ ìƒíƒœ í™•ì¸ ë° ê¸°ë³¸ê°’ ì„¤ì •
      set_fact:
        is_vulnerable: false
        facts_available: "{{ ansible_facts is defined and ansible_facts.os_family is defined }}"
        packages_available: "{{ ansible_facts is defined and ansible_facts.packages is defined }}"
      ignore_errors: true

    # 2. ì§„ë‹¨
    # GDM3 íŒ¨í‚¤ì§€ ì¡´ì¬ ì—¬ë¶€ë¡œ ë°ìŠ¤í¬íƒ‘ í™˜ê²½ì¸ì§€ ê°„ì ‘ì ìœ¼ë¡œ í™•ì¸
    - name: GDM3 ì¡´ì¬ ì—¬ë¶€ í™•ì¸
      ansible.builtin.package_facts:
        manager: auto
      when: 
        - facts_available | bool
        - ansible_facts.os_family == 'Debian'
      ignore_errors: true

    # íŒ¨í‚¤ì§€ ì •ë³´ ì¬í™•ì¸
    - name: íŒ¨í‚¤ì§€ ì •ë³´ ìƒíƒœ ì—…ë°ì´íŠ¸
      set_fact:
        packages_available: "{{ ansible_facts is defined and ansible_facts.packages is defined }}"
        gdm3_installed: "{{ ansible_facts is defined and ansible_facts.packages is defined and 'gdm3' in ansible_facts.packages }}"
      ignore_errors: true

    # dconf í‚¤ íŒŒì¼ì´ ì¡´ì¬í•˜ê³ , ë‚´ìš©ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸
    - name: dconf í™”ë©´ ì ê¸ˆ ì„¤ì • ì§„ë‹¨
      ansible.builtin.shell: |
        # íŒŒì¼ì´ ì—†ìœ¼ë©´ ì·¨ì•½(rc=1)
        if [ ! -f {{ dconf_keyfile_path }} ]; then
          exit 1
        fi
        # ì„¤ì • ë‚´ìš© í™•ì¸
        grep -qE "^\s*idle-delay=uint32 {{ lock_delay_seconds }}" "{{ dconf_keyfile_path }}" && \
        grep -qE "^\s*lock-enabled={{ lock_enabled | lower }}" "{{ dconf_keyfile_path }}"
      register: dconf_check
      changed_when: false
      failed_when: false
      when: gdm3_installed | bool
      ignore_errors: true

    # ì·¨ì•½ ì—¬ë¶€ ì¢…í•© íŒë‹¨
    - name: ì·¨ì•½ ì—¬ë¶€ ì¢…í•© íŒë‹¨
      ansible.builtin.set_fact:
        # GDMì´ ì—†ìœ¼ë©´ ì ê²€ ëŒ€ìƒì´ ì•„ë‹ˆë¯€ë¡œ ì–‘í˜¸(not vulnerable)
        # GDMì´ ìˆê³ , ì§„ë‹¨ ê²°ê³¼ê°€ ì–‘í˜¸(rc=0)ê°€ ì•„ë‹ˆë©´ ì·¨ì•½
        is_vulnerable: "{{ (dconf_check.rc != 0) if (gdm3_installed | bool) else false }}"
        report_timestamp: "{{ ansible_date_time.iso8601 }}"
      ignore_errors: true

    # 3. ì§„ë‹¨ ê²°ê³¼ ë³´ê³ 
    # ì§„ë‹¨ ê²°ê³¼ë¥¼ ì½˜ì†”ì— ê°„ë‹¨íˆ ì¶œë ¥
    - name: ì§„ë‹¨ ê²°ê³¼ ì½˜ì†” ì¶œë ¥
      ansible.builtin.debug:
        msg: "ì§„ë‹¨ê²°ê³¼: {% if not (gdm3_installed | bool) %}N/A (GNOME ë°ìŠ¤í¬íƒ‘ ì•„ë‹˜){% elif is_vulnerable %}ì·¨ì•½{% else %}ì–‘í˜¸{% endif %}"
      when: packages_available | bool

    # ì´ˆê¸° JSON ë³´ê³ ì„œ ë°ì´í„° ìƒì„±
    - name: ì´ˆê¸° JSON ë³´ê³ ì„œ ìƒì„±
      ansible.builtin.set_fact:
        current_report_data:
          playbook_name: "{{ playbook_name }}"
          task_description: "í™”ë©´ë³´í˜¸ê¸° ëŒ€ê¸° ì‹œê°„ ë° ì•”í˜¸ ì„¤ì •"
          diagnosis_result: "{% if not (gdm3_installed | bool) %}N/A{% elif is_vulnerable %}ì·¨ì•½{% else %}ì–‘í˜¸{% endif %}"
          is_vulnerable: "{{ is_vulnerable }}"
          timestamp: "{{ report_timestamp | default(ansible_date_time.iso8601) }}"
          hostname: "{{ inventory_hostname }}"
          vulnerability_details:
            reason: "{{ 'ì‹œìŠ¤í…œ ì „ì—­ í™”ë©´ë³´í˜¸ê¸° ì •ì±…ì´ ì„¤ì •ë˜ì–´ ìˆì§€ ì•Šê±°ë‚˜ ê¸°ì¤€ ë¯¸ë‹¬ì…ë‹ˆë‹¤.' if is_vulnerable else 'ì–‘í˜¸í•©ë‹ˆë‹¤.' }}"
          remediation_tasks_performed: []
      ignore_errors: true

    # ì´ˆê¸° JSON ë³´ê³ ì„œ íŒŒì¼ ì €ì¥
    - name: ì´ˆê¸° JSON ë³´ê³ ì„œ íŒŒì¼ ì €ì¥
      ansible.builtin.copy:
        content: "{{ current_report_data | to_nice_json }}"
        dest: "{{ result_json_path }}"
        mode: '0644'
      delegate_to: localhost
      become: false
      ignore_errors: true

    # 4. ì¡°ì¹˜
    # ì‹œìŠ¤í…œ ì „ì—­ dconf ì„¤ì •ì„ ìƒì„±í•˜ê³  ì ìš©
    - name: í™”ë©´ ì ê¸ˆ ì •ì±… ì¡°ì¹˜ ë¸”ë¡
      block:
        - name: GDM í”„ë¡œí•„ ë””ë ‰í„°ë¦¬ ìƒì„±
          ansible.builtin.file:
            path: "/etc/dconf/profile"
            state: directory
            mode: '0755'

        - name: GDM í”„ë¡œí•„ ì„¤ì •
          ansible.builtin.copy:
            content: |
              user-db:user
              system-db:gdm
              file-db:/usr/share/gdm/greeter-dconf-defaults
            dest: "{{ dconf_profile_path }}"
          notify: update dconf database

        - name: GDM dconf ë””ë ‰í„°ë¦¬ ìƒì„±
          ansible.builtin.file:
            path: "{{ dconf_db_path }}"
            state: directory
            mode: '0755'

        - name: í™”ë©´ ì ê¸ˆ ë³´ì•ˆ ì •ì±… ì„¤ì • íŒŒì¼ ìƒì„±
          ansible.builtin.blockinfile:
            path: "{{ dconf_keyfile_path }}"
            block: |
              [org/gnome/desktop/session]
              idle-delay=uint32 {{ lock_delay_seconds }}
              [org/gnome/desktop/screensaver]
              lock-enabled={{ lock_enabled | lower }}
            state: present
            create: yes
            mode: '0644'
          register: dconf_remediation
          notify: update dconf database

      when: is_vulnerable | bool
      ignore_errors: true

    # í•¸ë“¤ëŸ¬ë¥¼ ì¦‰ì‹œ ì‹¤í–‰í•´ì•¼ í•  ê²½ìš°
    - name: dconf ë°ì´í„°ë² ì´ìŠ¤ ë³€ê²½ì‚¬í•­ ì¦‰ì‹œ ì ìš©
      ansible.builtin.meta:
        flush_handlers
      when: is_vulnerable | bool
      ignore_errors: true

    # 5. ì¡°ì¹˜ ê²°ê³¼ ë³´ê³ 
    # ìˆ˜í–‰ëœ ì¡°ì¹˜ ì‘ì—… ê¸°ë¡
    - name: ìˆ˜í–‰ëœ ì¡°ì¹˜ ì‘ì—… ê¸°ë¡
      ansible.builtin.set_fact:
        remediation_done: "{{ dconf_remediation.changed | default(false) }}"
        remediation_tasks_performed: "{{ ['dconf ì‹œìŠ¤í…œ ì „ì—­ ì„¤ì • ì ìš©'] if dconf_remediation.changed | default(false) else [] }}"
      when: is_vulnerable | bool
      ignore_errors: true

    # ì¡°ì¹˜ ê²°ê³¼ë¥¼ ì½˜ì†”ì— ì¶œë ¥
    - name: ì¡°ì¹˜ ê²°ê³¼ ì½˜ì†” ì¶œë ¥
      ansible.builtin.debug:
        msg: |
          ì´ê´„ ì¡°ì¹˜ ê²°ê³¼: {% if remediation_done | default(false) %}ì¡°ì¹˜ ì™„ë£Œ
          {% elif not is_vulnerable %}ì¡°ì¹˜ ë¶ˆí•„ìš” (ì–‘í˜¸)
          {% else %}ì¡°ì¹˜ ì‹¤íŒ¨ (ìˆ˜ë™ ì¡°ì¹˜ í•„ìš”)
          --------------------------------------------------
          [ìˆ˜ë™ ì¡°ì¹˜ ê¶Œê³ ]
          {{ manual_remediation_guide }}
          --------------------------------------------------
          {% endif %}
      when: 
        - not ansible_check_mode 
        - gdm3_installed | bool
      ignore_errors: true

    # ìµœì¢… JSON ë³´ê³ ì„œì— ì¡°ì¹˜ ê²°ê³¼ ì¶”ê°€
    - name: ìµœì¢… JSON ë³´ê³ ì„œì— ì¡°ì¹˜ ê²°ê³¼ ì¶”ê°€
      ansible.builtin.set_fact:
        current_report_data: "{{ (lookup('file', result_json_path) | from_json) | combine({
            'remediation_applied': remediation_done | default(false),
            'remediation_result': 'ì¡°ì¹˜ ì™„ë£Œ' if (remediation_done | default(false)) else ('ì¡°ì¹˜ ë¶ˆí•„ìš”' if not is_vulnerable else 'ì¡°ì¹˜ ì‹¤íŒ¨ (ìˆ˜ë™ ì¡°ì¹˜ í•„ìš”)'),
            'remediation_timestamp': report_timestamp | default(ansible_date_time.iso8601),
            'remediation_tasks_performed': remediation_tasks_performed | default([]),
            'remediation_guide': manual_remediation_guide if (is_vulnerable and not (remediation_done | default(false))) else ''
          }, recursive=True) }}"
      when: 
        - not ansible_check_mode 
        - is_vulnerable | bool
      ignore_errors: true

    # ìµœì¢… JSON ë³´ê³ ì„œ íŒŒì¼ ë®ì–´ì“°ê¸°
    - name: ìµœì¢… JSON ë³´ê³ ì„œ íŒŒì¼ ì €ì¥
      ansible.builtin.copy:
        content: "{{ current_report_data | to_nice_json }}"
        dest: "{{ result_json_path }}"
        mode: '0644'
      delegate_to: localhost
      become: false
      when: 
        - not ansible_check_mode 
        - is_vulnerable | bool
      ignore_errors: true